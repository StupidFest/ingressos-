<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Gerador de Ingressos - Com Scanner</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>

<style>
  body{font-family:Arial,sans-serif;background:#f0f2f5;display:flex;align-items:center;justify-content:center;padding:20px;margin:0}
  .card{width:100%;max-width:820px;background:#fff;border-radius:12px;padding:18px;box-shadow:0 8px 30px rgba(0,0,0,0.12)}
  h1{margin:0 0 12px;font-size:20px;text-align:center}
  .cols{display:flex;gap:16px;flex-wrap:wrap}
  .col{flex:1;min-width:260px}
  input,select,button{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #ddd;font-size:14px;text-transform:uppercase}
  button{background:#0069ff;color:#fff;border:none;cursor:pointer;font-weight:700}
  #qrcode{display:flex;justify-content:center;margin-top:10px}
  #status{margin-top:8px;font-size:14px;text-align:center;min-height:40px}
  /* Scanner modal */
  .modal{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:9999}
  .modal.show{display:flex}
  .modal-content{background:#0d1117;color:#fff;padding:16px;border-radius:12px;max-width:420px;width:90%;text-align:center}
  #reader{width:100%;max-width:360px;margin:8px auto;border-radius:10px;overflow:hidden}
  .result-ok{color:#00ff88;font-weight:700}
  .result-used{color:#ffd166;font-weight:700}
  .result-err{color:#ff6b6b;font-weight:700}
</style>
</head>
<body>

<div class="card">
  <h1>üé´ GERADOR DE INGRESSOS</h1>
  <div class="cols">
    <div class="col">
      <input id="name" placeholder="Nome completo" />
      <input id="value" placeholder="Valor (ex: 50)" />
      <select id="type">
        <option value="">‚Äî SELECIONE TIPO ‚Äî</option>
        <option>PROMOCIONAL</option>
        <option>NORMAL</option>
        <option>VIP</option>
      </select>
      <button id="btnGenerate">GERAR INGRESSO</button>
      <div id="status"></div>
    </div>

    <div class="col">
      <div id="previewCard" style="border-radius:12px;padding:12px;background:#111;color:#fff;text-align:center">
        <div id="previewBg" style="background-image:url('https://i.imgur.com/jjrAjpB.png');background-size:cover;background-position:center;padding:18px;border-radius:8px;">
          <div id="previewNome" style="font-weight:800;font-size:20px;letter-spacing:1px">NOME</div>
          <div id="previewTipo" style="margin-top:8px">TIPO</div>
          <div id="previewValor" style="margin-top:6px">VALOR</div>
          <div id="qrcode" style="margin-top:10px"></div>
        </div>
      </div>
      <div style="height:8px"></div>
      <button id="btnScanner">üì∑ SCANNER INGRESSO</button>
    </div>
  </div>
</div>

<!-- Modal scanner -->
<div id="modalScanner" class="modal" role="dialog" aria-modal="true">
  <div class="modal-content">
    <h2 style="margin:0 0 8px">üì∏ SCANNER</h2>
    <div id="reader"></div>
    <div id="scanResult" style="margin-top:10px">Aponte a c√¢mera para o QR Code</div>
    <div style="margin-top:12px">
      <button id="closeScanner" style="background:#444">FECHAR</button>
    </div>
  </div>
</div>

<script>
/* ---------- CONFIG ---------- */
const API_URL = "https://script.google.com/macros/s/AKfycbxyBFcsu3YIpJUFkeIVF5dN9DgF2G6eyyUD2JtQUAeUQcOM1179sRb8GZVHQrv-n9ydDg/exec";
/* ---------------------------- */

/* Helpers */
function gerarCodigo(){ const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; let out=""; for(let i=0;i<8;i++) out+=chars.charAt(Math.floor(Math.random()*chars.length)); return out; }
function clearQRCode(){ document.getElementById('qrcode').innerHTML = ''; }
function renderQRCode(text, size=160){ clearQRCode(); const holder = document.createElement('div'); holder.style.background="#fff"; holder.style.padding="8px"; holder.style.borderRadius="8px"; holder.style.display="inline-block"; document.getElementById('qrcode').appendChild(holder); new QRCode(holder,{ text, width: size, height: size }); return holder; }
function sendJsonp(params, cb){ const cbName='cb_'+Date.now()+'_'+Math.floor(Math.random()*10000); window[cbName]=r=>{ cb(null,r); delete window[cbName]; document.getElementById(cbName+'_s')?.remove(); }; const qs=new URLSearchParams({...params, callback:cbName}).toString(); const s=document.createElement('script'); s.id=cbName+'_s'; s.src=API_URL + (API_URL.includes('?')? '&' : '?') + qs; s.onerror=()=>cb(new Error('JSONP fail')); document.body.appendChild(s); }

async function loadImage(url){ return new Promise((res,rej)=>{ const img=new Image(); img.crossOrigin='Anonymous'; img.onload=()=>res(img); img.onerror=()=>rej(new Error('load fail')); img.src=url; }); }

/* ---------- PDF / gerar ---------- */
async function gerarPdfDataUri(name, value, type, code){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:'landscape', unit:'mm', format:[148,105] });
  const bg = await loadImage('https://i.imgur.com/jjrAjpB.png');
  const pageW=148, pageH=105;
  const ratio=Math.min(pageW/bg.width, pageH/bg.height);
  const imgW=bg.width*ratio, imgH=bg.height*ratio, x=(pageW-imgW)/2, y=(pageH-imgH)/2;
  doc.addImage(bg,'PNG',x,y,imgW,imgH);

  // texts
  doc.setFont("helvetica","bold"); doc.setFontSize(26); doc.setTextColor(255,255,255);
  doc.text(name.toUpperCase(), pageW/2, y+25, { align: 'center' });
  doc.setFontSize(14);
  doc.text(('VALOR: '+value).toUpperCase(), pageW/2, y+45, { align: 'center' });
  doc.text(('TIPO: '+type).toUpperCase(), pageW/2, y+58, { align: 'center' });

  // qr from DOM
  const holder = document.querySelector('#qrcode div');
  if(holder){
    const canvas = holder.querySelector('canvas');
    if(canvas){
      const data = canvas.toDataURL('image/png');
      const qrSize = 42;
      const qrX = pageW/2 - qrSize/2;
      const qrY = y + imgH - qrSize - 6;
      doc.addImage(data,'PNG',qrX,qrY,qrSize,qrSize);
    }
  }

  return doc.output('datauristring');
}

async function generateAndSend(){
  const name = (document.getElementById('name').value||'').trim();
  const value = (document.getElementById('value').value||'').trim();
  const type = (document.getElementById('type').value||'').trim();
  if(!name || !value || !type){ document.getElementById('status').textContent='‚ö†Ô∏è Preencha Nome, Valor e Tipo.'; return; }

  const code = gerarCodigo();
  renderQRCode(code,160);
  // update preview
  document.getElementById('previewNome').innerText = name.toUpperCase();
  document.getElementById('previewTipo').innerText = type.toUpperCase();
  document.getElementById('previewValor').innerText = 'VALOR: '+value.toUpperCase();
  document.getElementById('status').textContent = '‚è≥ Gerando ingresso...';

  try{
    const pdfDataUri = await gerarPdfDataUri(name, value, type, code);
    // force download
    const a = document.createElement('a'); a.href = pdfDataUri; a.download = `Ingresso_${name.replace(/[^A-Z0-9]/ig,'')}_${code}.pdf`; document.body.appendChild(a); a.click(); a.remove();
    document.getElementById('status').innerHTML = `‚úÖ Ingresso gerado: <b>${code}</b>`;
    // save via JSONP
    sendJsonp({ action: 'generate', name: name.toUpperCase(), value: value.toUpperCase(), type: type.toUpperCase(), codigo: code }, (err, resp)=>{
      if(err){ document.getElementById('status').textContent = '‚ùå Erro ao salvar (rede)'; return; }
      if(resp && resp.ok){ document.getElementById('status').innerHTML += ' ‚Äî Salvo na planilha.'; }
    });
  }catch(err){
    document.getElementById('status').textContent = '‚ùå Erro: '+err.message;
  }
}

/* ---------- Scanner (modal) ---------- */
let html5QrCodeInstance = null;
const modal = document.getElementById('modalScanner');
const readerEl = document.getElementById('reader');
const scanResult = document.getElementById('scanResult');

function openScanner(){
  modal.classList.add('show');
  scanResult.textContent = 'Aponte a c√¢mera para o QR Code';
  // create instance
  html5QrCodeInstance = new Html5Qrcode('reader');
  Html5Qrcode.getCameras().then(cameras=>{
    if(cameras && cameras.length){
      const cam = cameras[0].id;
      html5QrCodeInstance.start(cam, { fps:10, qrbox:250 },
        decoded => {
          // stop and validate
          html5QrCodeInstance.stop().then(()=>{
            validateCode(decoded.trim());
          }).catch(()=>{ validateCode(decoded.trim()); });
        },
        err => { /* ignore */ }
      ).catch(e=>{ scanResult.textContent = '‚ùå Erro c√¢mera: '+e; });
    } else {
      scanResult.textContent = '‚ùå C√¢mera n√£o encontrada';
    }
  }).catch(e=>{ scanResult.textContent = '‚ùå Erro ao obter c√¢meras'; });
}

function closeScanner(){
  modal.classList.remove('show');
  scanResult.textContent = '';
  if(html5QrCodeInstance){
    html5QrCodeInstance.stop().catch(()=>{});
    html5QrCodeInstance.clear().catch(()=>{});
    html5QrCodeInstance = null;
  }
}

function validateCode(code){
  scanResult.textContent = '‚è≥ Validando...';
  // JSONP callback approach
  const cb = 'cb_'+Date.now();
  window[cb] = function(resp){
    if(resp && resp.ok && resp.status === 'OK'){
      scanResult.innerHTML = '<span class="result-ok">‚úÖ INGRESSO CONFIRMADO</span><br><b>'+resp.nome+'</b><br>'+resp.tipo+' - R$'+resp.valor;
    } else if(resp && resp.ok && resp.status === 'USADO'){
      scanResult.innerHTML = '<span class="result-used">‚ö†Ô∏è INGRESSO J√Å UTILIZADO</span>';
    } else {
      scanResult.innerHTML = '<span class="result-err">‚ùå C√ìDIGO N√ÉO ENCONTRADO</span>';
    }
    // cleanup script tag
    document.getElementById(cb+'_s')?.remove();
    try{ delete window[cb]; }catch(e){}
    // auto close after 3s
    setTimeout(closeScanner, 3500);
  };
  const script = document.createElement('script');
  script.id = cb+'_s';
  script.src = API_URL + (API_URL.includes('?')? '&' : '?') + new URLSearchParams({ action:'validate', codigo: code, callback: cb }).toString();
  script.onerror = function(){ scanResult.textContent = '‚ùå Erro rede'; };
  document.body.appendChild(script);
}

/* ---------- Events ---------- */
document.getElementById('btnGenerate').addEventListener('click', generateAndSend);
document.getElementById('btnScanner').addEventListener('click', openScanner);
document.getElementById('closeScanner').addEventListener('click', closeScanner);
</script>
</body>
</html>
