<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ingressos — Gerar & Validar</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  body{background:linear-gradient(135deg,#0b3b86,#4e73df);color:#fff;font-family:Inter,system-ui,Arial;margin:0;padding:24px}
  .card{border-radius:12px}
  .container{max-width:1000px}
  #reader{width:100%;max-width:420px;height:320px;background:#000;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#888;margin:0 auto}
  #preview img{max-width:280px;border-radius:8px;margin-top:8px}
  .small-muted{font-size:0.85rem;color:#dfe7ff}
  footer{font-size:0.85rem;color:#cfe0ff;margin-top:16px}
</style>

<!-- libs -->
<script src="https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<div class="container mx-auto">
  <h1 class="text-center mb-4">Sistema de Ingressos — Gerar & Validar</h1>

  <div class="row g-3">
    <!-- Gerar -->
    <div class="col-md-6">
      <div class="card p-3 shadow-sm">
        <h5>Gerar ingresso</h5>
        <p class="small-muted">Preencha, gere o PDF (local) e envie ao servidor (Apps Script) via JSONP.</p>

        <form id="formTicket">
          <div class="mb-2">
            <label class="form-label">Nome</label>
            <input class="form-control" name="name" id="nome" required placeholder="EX: DOUGLAS">
          </div>
          <div class="mb-2">
            <label class="form-label">Valor</label>
            <input class="form-control" name="value" id="valor" required placeholder="EX: 20 REAIS">
          </div>
          <div class="mb-2">
            <label class="form-label">Tipo</label>
            <select id="tipo" class="form-select" name="type" required>
              <option value="NORMAL" selected>NORMAL</option>
              <option value="PROMOCIONAL">PROMOCIONAL</option>
              <option value="VIP">VIP</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">Comprovante (opcional - imagem ou PDF)</label>
            <input type="file" id="comprovante" class="form-control" accept="image/*,application/pdf">
          </div>

          <div id="preview" class="mb-2"></div>

          <div id="generateStatus" class="mb-2 small-muted"></div>

          <button class="btn btn-warning w-100" type="submit">Gerar e Enviar</button>
        </form>
      </div>
    </div>

    <!-- Scanner -->
    <div class="col-md-6">
      <div class="card p-3 shadow-sm">
        <h5>Scanner / Validador</h5>
        <p class="small-muted">Abra a câmera no celular e escaneie o QR do ingresso.</p>
        <div class="d-grid gap-2 mb-2">
          <button id="openScanner" class="btn btn-success">Abrir scanner (câmera)</button>
          <button id="stopScanner" class="btn btn-secondary" style="display:none;">Parar scanner</button>
        </div>
        <div id="reader">Abrir câmera...</div>
        <div id="scanResult" class="mt-2"></div>
      </div>
    </div>
  </div>

  <footer class="text-center">Frontend hospedado no GitHub Pages • Backend: Google Apps Script (JSONP)</footer>
</div>

<script>
/* ----------------------------
   CONFIGURE AQUI (seu endpoint)
   ---------------------------- */
const API_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLi-DQtP2ohMa2p89xnCxV0aacLyA5gFcMzvBhJG1y1copkd1sd7oJB9ZvqnAnSJC3DrX_QHWscgNOWin3si2JYCw0w8nVe8KBrvErypeVOXSlQdftbi_CcWK5liqCGXxjqEd4ZWADQdQZXfxJKJtzyzmy0bfZPv85GzbripWlLPKdGAkEKXPgZJCen6uWaVWQ7DzigV-Olgf_2sBH20aD2I9uPBIZJWZcDHDQPLpA3zQY_d-GSrCHoUc1Mlp679MVksvkvZhTAyx6Tfvf7Rm7As8hcAnLCHskXYA0-q_OtZgKcj_XuNNP5SOUKLIFTPQ1G1eW6qcx7YduOMBtDE0Pf1H_UP2eUj0Y0PrSIULdIfOV2Dc2Y_7xYs6p3BwzC89NrEawtWDeC030MwsKz_U67j-EO6suLiRYVkAz8jKIwDfrFpMegOZ1o6N7sugJme-jiIMvFD&lib=MSW9ZGRKC9kPKkEUX5VrwMqJJADHPaQrq";

/* helpers */
function toBase64(file){ return new Promise((resolve,reject)=>{ const r=new FileReader(); r.onload=()=>resolve(r.result); r.onerror=reject; r.readAsDataURL(file); }); }
function gerarCodigo(){ const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; let c=""; for(let i=0;i<8;i++) c+=chars.charAt(Math.floor(Math.random()*chars.length)); return c; }

/* ---------- Gerar ingresso (JSONP) ---------- */
document.getElementById('formTicket').addEventListener('submit', async (ev) => {
  ev.preventDefault();
  const nome = document.getElementById('nome').value.trim();
  const valor = document.getElementById('valor').value.trim();
  const tipo = document.getElementById('tipo').value;
  if(!nome || !valor || !tipo){ alert('Preencha todos os campos'); return; }

  const comprovanteFile = document.getElementById('comprovante').files[0];
  const comprovanteBase64 = comprovanteFile ? await toBase64(comprovanteFile) : "";

  const codigo = gerarCodigo();

  // gera PDF simples com jsPDF + QR
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'landscape',unit:'mm',format:[148,105]});
  // fundo simples
  doc.setFillColor(30,40,80); doc.rect(0,0,148,105,'F');
  doc.setFontSize(24); doc.setTextColor(255,255,255); doc.text(nome.toUpperCase(),74,24,{align:'center'});
  doc.setFontSize(12); doc.text(`VALOR: ${valor}`,74,44,{align:'center'});
  doc.text(`TIPO: ${tipo}`,74,54,{align:'center'});
  doc.setFontSize(10); doc.text(`CÓDIGO: ${codigo}`,74,68,{align:'center'});

  // gera QR temporário no DOM e converte em imagem
  const qrDiv = document.createElement('div'); qrDiv.style.position='absolute'; qrDiv.style.left='-9999px';
  document.body.appendChild(qrDiv);
  new QRCode(qrDiv, { text: codigo, width: 110, height: 110 });
  await new Promise(r => setTimeout(r, 300));
  const canvas = await html2canvas(qrDiv, { backgroundColor: null });
  const imgData = canvas.toDataURL('image/png');
  document.body.removeChild(qrDiv);
  doc.addImage(imgData, 'PNG', 54, 70, 40, 40);

  const pdfBase64 = doc.output('datauristring');

  // preview
  document.getElementById('preview').innerHTML = `<div><strong>Código:</strong> ${codigo}</div><img src="${imgData}" alt="qr">`;
  document.getElementById('generateStatus').textContent = 'Enviando...';

  // JSONP: criar callback dinâmico e script tag
  const callbackName = "cbg_" + Math.random().toString(36).slice(2);
  window[callbackName] = (resp) => {
    try {
      if (resp && resp.ok) {
        document.getElementById('generateStatus').innerHTML = `✅ Ingresso gerado! Código: <b>${resp.codigo}</b><br><a href="${resp.pdfUrl}" target="_blank" style="color:#fff;text-decoration:underline">Abrir PDF</a>`;
      } else {
        document.getElementById('generateStatus').textContent = 'Erro: ' + (resp && resp.error ? resp.error : 'Resposta inválida');
      }
    } finally {
      // cleanup
      delete window[callbackName];
      const s = document.getElementById(callbackName); if (s) s.remove();
    }
  };

  // montar url (atenção ao tamanho da URL)
  const baseUrl = API_URL;
  const params = [
    "action=generate",
    "name="+encodeURIComponent(nome),
    "value="+encodeURIComponent(valor),
    "type="+encodeURIComponent(tipo),
    "codigo="+encodeURIComponent(codigo),
    "pdfBase64="+encodeURIComponent(pdfBase64),
    "comprovante="+encodeURIComponent(comprovanteBase64),
    "callback="+encodeURIComponent(callbackName)
  ].join("&");

  const script = document.createElement('script');
  script.id = callbackName;
  script.src = baseUrl + (baseUrl.indexOf('?') === -1 ? '?' : '&') + params;
  document.body.appendChild(script);
});

/* ---------- Scanner / validação via JSONP ---------- */
let scanner = null;
const readerEl = document.getElementById('reader');
const scanResult = document.getElementById('scanResult');

document.getElementById('openScanner').addEventListener('click', () => {
  scanResult.innerHTML = '';
  readerEl.innerHTML = '<div style="color:#888">Abrindo câmera... permita o acesso</div>';
  setTimeout(() => {
    scanner = new Html5Qrcode('reader');
    Html5Qrcode.getCameras().then(devices => {
      if(devices && devices.length){
        const back = devices.find(d => /back|rear|environment/i.test(d.label)) || devices[0];
        scanner.start(back.id, { fps: 10, qrbox: 250 }, qrSuccess, err => { /*ignore*/ })
          .then(()=>{ document.getElementById('stopScanner').style.display='inline-block'; })
          .catch(e => { scanResult.innerText = 'Erro ao iniciar câmera: ' + e; });
      } else {
        scanResult.innerText = 'Nenhuma câmera detectada';
      }
    }).catch(e => { scanResult.innerText = 'Erro ao listar câmeras: ' + e; });
  }, 500);
});

document.getElementById('stopScanner').addEventListener('click', () => {
  if(scanner){
    scanner.stop().then(()=>{ scanner.clear(); scanner=null; document.getElementById('stopScanner').style.display='none'; readerEl.innerHTML=''; }).catch(()=>{});
  }
});

function qrSuccess(decodedText){
  // parar e validar via JSONP
  if(scanner){ scanner.stop().then(()=>scanner.clear()).catch(()=>{}); scanner=null; document.getElementById('stopScanner').style.display='none'; }
  scanResult.innerHTML = 'Lendo ingresso...';

  const callbackName = "cbv_" + Math.random().toString(36).slice(2);
  window[callbackName] = (resp) => {
    try {
      if (resp && resp.ok) {
        if (resp.status === 'OK') {
          scanResult.innerHTML = `<div style="color:#7fffd4;font-weight:700">INGRESSO VÁLIDO ✅</div>
            <div><b>${resp.nome}</b><br>${resp.tipo} — ${resp.valor}</div>
            <div style="margin-top:8px"><button onclick="restartScanner()" class="btn btn-sm btn-light">Ler outro</button></div>`;
        } else if (resp.status === 'USADO') {
          scanResult.innerHTML = `<div style="color:#ff9b9b;font-weight:700">INGRESSO JÁ UTILIZADO ❌</div>`;
        } else {
          scanResult.innerHTML = `<div style="color:#ffd166;font-weight:700">Não encontrado</div>`;
        }
      } else {
        scanResult.innerHTML = 'Erro: ' + (resp && resp.error ? resp.error : 'Resposta inválida');
      }
    } finally {
      delete window[callbackName];
      const s = document.getElementById(callbackName); if (s) s.remove();
    }
  };

  const baseUrl = API_URL;
  const params = [
    "action=validate",
    "codigo="+encodeURIComponent(decodedText),
    "validator="+encodeURIComponent("Douglas"),
    "callback="+encodeURIComponent(callbackName)
  ].join("&");

  const script = document.createElement('script');
  script.id = callbackName;
  script.src = baseUrl + (baseUrl.indexOf('?') === -1 ? '?' : '&') + params;
  document.body.appendChild(script);
}

function restartScanner(){ document.getElementById('scanResult').innerHTML=''; document.getElementById('reader').innerHTML=''; setTimeout(()=>{ document.getElementById('openScanner').click(); },200); }

</script>
</body>
</html>
