<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gerador de Ingressos ‚Äî 2025</title>

<!-- libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root{ --accent:#00c9a7; --accent2:#92fe9d; --bg1:#0b3b86; --bg2:#4e54c8; }
  *{box-sizing:border-box}
  body{
    font-family:Inter,system-ui,Arial; margin:0; min-height:100vh;
    display:flex; align-items:center; justify-content:center;
    background:linear-gradient(135deg,var(--bg1),var(--bg2)); color:#fff;
    padding:20px;
  }
  .card{
    width:100%; max-width:460px; background:rgba(255,255,255,0.06);
    padding:18px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.4);
  }
  h1{font-size:20px;margin:0 0 12px;text-align:center}
  input,select,button{width:100%; padding:10px; border-radius:8px; border:0; margin:8px 0; font-size:15px}
  input,select{background:rgba(255,255,255,0.06); color:#fff; text-align:center}
  button{cursor:pointer; font-weight:700; color:#04203a}
  .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent2))}
  .btn-outline{background:transparent;border:1px solid rgba(255,255,255,0.12); color:#fff}
  #qbox{display:flex;flex-direction:column;align-items:center;gap:8px;margin-top:12px}
  #qrcode{width:180px;height:180px;background:#fff;padding:8px;border-radius:12px;display:flex;align-items:center;justify-content:center}
  #mensagem{margin-top:8px;font-size:0.95rem;text-align:center}
  #downloadBtn{display:none}
  @media (max-width:420px){ #qrcode{width:150px;height:150px} }
</style>
</head>
<body>
  <div class="card" role="main">
    <h1>üé´ Gerador de Ingressos</h1>

    <input id="nome" placeholder="Nome completo (ex: AMANDA)" autocomplete="name" />
    <input id="valor" placeholder="Valor (ex: 50)" inputmode="numeric" />
    <select id="tipo">
      <option value="">‚Äî Selecione tipo ‚Äî</option>
      <option value="VIP">VIP</option>
      <option value="Pista">Pista</option>
      <option value="Backstage">Backstage</option>
    </select>

    <button id="gerar" class="btn-primary">Gerar ingresso</button>

    <div id="qbox" aria-live="polite">
      <div id="mensagem"></div>
      <div id="qrcode" aria-hidden="true"></div>
      <button id="downloadBtn" class="btn-outline">üìÑ Baixar PDF</button>
    </div>
  </div>

<script>
/* ========== CONFIGURE AQUI ========== */
const API_URL = "https://script.google.com/macros/s/AKfycbzZVETR1_gVv-ErwDtKPNn61k89PHUYCtujYeDD9NvuF2IiVEGhjqzT3CkwsG9UlVsMuA/exec";
/* ==================================== */

const gerarBtn = document.getElementById('gerar');
const nomeInput = document.getElementById('nome');
const valorInput = document.getElementById('valor');
const tipoSelect = document.getElementById('tipo');
const mensagemEl = document.getElementById('mensagem');
const qrcodeContainer = document.getElementById('qrcode');
const downloadBtn = document.getElementById('downloadBtn');

let codigoAtual = "";
let nomeAtual = "";
let valorAtual = "";
let tipoAtual = "";

// Gera c√≥digo
function gerarCodigo(){
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let out = "";
  for(let i=0;i<8;i++) out += chars.charAt(Math.floor(Math.random()*chars.length));
  return out;
}

// Remove scripts previously in DOM (cleanup JSONP)
function removeJsonpScript(id){
  const s = document.getElementById(id);
  if(s) s.remove();
}

// Render QR (usando qrcodejs)
function renderQRCode(text){
  qrcodeContainer.innerHTML = "";
  // qrcodejs cria div, logo colocar em branco mas o qr interno escuro
  const wrapper = document.createElement('div');
  wrapper.style.background = "#fff";
  wrapper.style.padding = "8px";
  wrapper.style.borderRadius = "8px";
  qrcodeContainer.appendChild(wrapper);

  new QRCode(wrapper, {
    text: String(text || ""),
    width: wrapper.clientWidth || 160,
    height: wrapper.clientWidth || 160,
    colorDark: "#000000",
    colorLight: "#ffffff",
    correctLevel: QRCode.CorrectLevel.H
  });
}

// Gerar PDF e for√ßar download (usando jsPDF)
async function gerarPdfBaixar(){
  if(!codigoAtual) return;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'portrait',unit:'mm',format:'A6'}); // pequeno
  doc.setFontSize(14);
  doc.setFont("helvetica","bold");
  doc.text("üéüÔ∏è INGRESSO OFICIAL", 20, 12);

  doc.setFontSize(11);
  doc.setFont("helvetica","normal");
  doc.text(`Nome: ${nomeAtual}`, 10, 30);
  doc.text(`Tipo: ${tipoAtual}`, 10, 38);
  doc.text(`Valor: ${valorAtual}`, 10, 46);
  doc.text(`C√≥digo: ${codigoAtual}`, 10, 54);

  // pega o canvas gerado pelo QR (qrcodejs usa <img> ou <canvas>)
  const qrCanvas = qrcodeContainer.querySelector("canvas") || qrcodeContainer.querySelector("img");
  if(qrCanvas){
    let imgData;
    if(qrCanvas.tagName.toLowerCase() === "canvas") {
      imgData = qrCanvas.toDataURL("image/png");
    } else {
      // <img> caso seja gerado como imagem
      const img = qrCanvas;
      // criar canvas tempor√°rio para garantir toDataURL
      const c = document.createElement('canvas');
      c.width = img.naturalWidth || 180;
      c.height = img.naturalHeight || 180;
      const ctx = c.getContext('2d');
      ctx.drawImage(img,0,0);
      imgData = c.toDataURL('image/png');
    }
    // dimensiona no PDF
    doc.addImage(imgData, 'PNG', 60, 20, 40, 40);
  }

  // salvar com nome + codigo
  const safeName = String(nomeAtual).replace(/[^a-z0-9\-_ ]/ig,'');
  const filename = `Ingresso_${safeName}_${codigoAtual}.pdf`;
  doc.save(filename);
}

// Envia dados para Apps Script via JSONP (callback)
function enviarJsonp(paramsObj, callbackFn){
  const callbackName = 'cb_' + Date.now() + '_' + Math.floor(Math.random()*9999);
  window[callbackName] = function(resp){
    try{ callbackFn(null, resp); } catch(err){ callbackFn(err); }
    // cleanup
    try{ delete window[callbackName]; }catch(e){}
    removeJsonpScript(callbackName + '_script');
  };

  const urlParams = new URLSearchParams({...paramsObj, callback: callbackName}).toString();
  const script = document.createElement('script');
  script.src = API_URL + (API_URL.indexOf('?')===-1 ? '?' : '&') + urlParams;
  script.id = callbackName + '_script';
  script.onerror = function(e){
    callbackFn(new Error('Erro carregando JSONP'), null);
    delete window[callbackName];
    removeJsonpScript(callbackName + '_script');
  };
  document.body.appendChild(script);
}

// Bot√£o gerar
gerarBtn.addEventListener('click', async () => {
  mensagemEl.textContent = "";
  qrcodeContainer.innerHTML = "";
  downloadBtn.style.display = 'none';

  nomeAtual = (nomeInput.value || "").trim();
  valorAtual = (valorInput.value || "").trim();
  tipoAtual = (tipoSelect.value || "").trim();

  if(!nomeAtual || !valorAtual || !tipoAtual){
    mensagemEl.textContent = "‚ö†Ô∏è Preencha Nome, Valor e Tipo.";
    return;
  }

  codigoAtual = gerarCodigo();
  renderQRCode(codigoAtual);
  mensagemEl.innerHTML = `‚úÖ Gerado: <b>${codigoAtual}</b> ‚Äî salvando na planilha...`;

  // envia para Apps Script (somente dados essenciais)
  const params = {
    action: "generate",
    name: nomeAtual,
    value: valorAtual,
    type: tipoAtual,
    codigo: codigoAtual
  };

  enviarJsonp(params, (err, resp) => {
    if(err){
      mensagemEl.textContent = "‚ùå Erro de rede ao salvar: " + (err.message || err);
      console.error(err);
      return;
    }
    if(resp && resp.ok){
      mensagemEl.innerHTML = `‚úÖ Ingresso salvo! C√≥digo: <b>${resp.codigo}</b>`;
      // habilita bot√£o PDF
      downloadBtn.style.display = 'inline-block';
      // optionally if server returned pdfUrl you could create a link to it
    } else {
      mensagemEl.innerHTML = "‚ùå Erro ao salvar: " + (resp && (resp.error||resp.message) ? (resp.error||resp.message) : "Resposta inv√°lida");
    }
  });
});

// download PDF
downloadBtn.addEventListener('click', gerarPdfBaixar);

// accessibility: press enter in inputs triggers generate
[nomeInput, valorInput].forEach(i => i.addEventListener('keydown', ev => {
  if(ev.key === 'Enter') gerarBtn.click();
}));

</script>
</body>
</html>
