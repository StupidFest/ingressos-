<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üé´ Sistema de Ingressos</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
* { box-sizing: border-box; margin:0; padding:0; font-family: 'Segoe UI', sans-serif; }
body {
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
  background: linear-gradient(135deg,#74ebd5,#acb6e5);
}

.container {
  width:100%;
  max-width:450px;
  background:#fff;
  border-radius:20px;
  padding:25px;
  box-shadow: 0 15px 40px rgba(0,0,0,0.2);
  display:flex;
  flex-direction:column;
  align-items:center;
}

h1 {
  font-size:24px;
  margin-bottom:20px;
  text-align:center;
  color:#333;
}

input, select, button {
  width:100%;
  padding:12px;
  margin:8px 0;
  border-radius:12px;
  border:1px solid #ccc;
  font-size:15px;
  outline:none;
}

input:focus, select:focus {
  border-color:#007bff;
  box-shadow:0 0 5px rgba(0,123,255,0.5);
}

button {
  background:#007bff;
  color:#fff;
  border:none;
  font-weight:bold;
  cursor:pointer;
  transition:0.2s;
}

button:hover { background:#005fd1; }

#qrcode {
  margin-top:15px;
  display:flex;
  justify-content:center;
}

#status {
  margin-top:12px;
  font-size:15px;
  text-align:center;
  min-height:24px;
  font-weight:bold;
  color:#555;
}

#scanner-area {
  display:none;
  flex-direction:column;
  align-items:center;
  text-align:center;
  width:100%;
}

#reader {
  width:100%;
  max-width:360px;
  margin:auto;
  border-radius:20px;
  overflow:hidden;
  border:3px solid rgba(0,0,0,0.2);
}

.switcher {
  display:flex;
  justify-content:center;
  gap:10px;
  margin-top:15px;
}

.message-overlay {
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background: rgba(0,0,0,0.6);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:9999;
  display:none;
  flex-direction:column;
  color:#fff;
  font-size:28px;
  font-weight:bold;
  text-align:center;
  padding:20px;
  border-radius:15px;
}
</style>
</head>
<body>

<div class="container">
  <h1>üéüÔ∏è Sistema de Ingressos</h1>

  <div id="generator">
    <input id="name" placeholder="Nome completo" />
    <input id="value" placeholder="Valor (ex: 50)" />
    <select id="type">
      <option value="">‚Äî Selecione tipo ‚Äî</option>
      <option>VIP</option>
      <option>Pista</option>
      <option>Camarote</option>
    </select>
    <button id="btnGenerate">Gerar ingresso</button>
    <div id="qrcode"></div>
    <div id="status"></div>
  </div>

  <div id="scanner-area">
    <div id="reader"></div>
    <div id="scan-status" style="font-size:18px;margin-top:12px;"></div>
  </div>

  <div class="switcher">
    <button id="switchToScan">üì∑ Ler Ingresso</button>
    <button id="switchToGen" style="display:none">üßæ Gerar Ingresso</button>
  </div>
</div>

<div id="messageOverlay" class="message-overlay"></div>

<audio id="soundSuccess">
  <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAIlYAAESsAAACABAAZGF0YYQAAAAA" type="audio/wav">
</audio>

<audio id="soundFail">
  <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAIlYAAESsAAACABAAZGF0YYQAAAAA" type="audio/wav">
</audio>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzZVETR1_gVv-ErwDtKPNn61k89PHUYCtujYeDD9NvuF2IiVEGhjqzT3CkwsG9UlVsMuA/exec";
const BACKGROUND_IMG = "https://i.imgur.com/91zRBfN.png";

const btnGenerate = document.getElementById('btnGenerate');
const qrcodeDiv = document.getElementById('qrcode');
const statusEl = document.getElementById('status');
const scanStatus = document.getElementById('scan-status');
const generator = document.getElementById('generator');
const scannerArea = document.getElementById('scanner-area');
const btnScan = document.getElementById('switchToScan');
const btnGen = document.getElementById('switchToGen');
let html5QrScanner;

const overlay = document.getElementById('messageOverlay');
const soundSuccess = document.getElementById('soundSuccess');
const soundFail = document.getElementById('soundFail');

function gerarCodigo(){
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let out="";
  for(let i=0;i<8;i++) out+=chars.charAt(Math.floor(Math.random()*chars.length));
  return out;
}

function sendJsonp(paramsObj, cb){
  const callbackName = 'cb_' + Date.now() + '_' + Math.floor(Math.random()*10000);
  window[callbackName] = function(resp){
    cb(null, resp);
    delete window[callbackName];
    document.getElementById(callbackName + '_script')?.remove();
  };
  const qs = new URLSearchParams({...paramsObj, callback: callbackName}).toString();
  const script = document.createElement('script');
  script.id = callbackName + '_script';
  script.src = API_URL + (API_URL.includes('?')? '&' : '?') + qs;
  script.onerror = () => cb(new Error('Erro JSONP'));
  document.body.appendChild(script);
}

function clearQRCode(){ qrcodeDiv.innerHTML = ""; }

function renderQRCode(text, size=240){
  clearQRCode();
  const holder = document.createElement('div');
  holder.style.background = "#fff";
  holder.style.padding = "8px";
  holder.style.borderRadius = "8px";
  qrcodeDiv.appendChild(holder);
  new QRCode(holder, {
    text,
    width: size,
    height: size,
    colorDark:"#000000",
    colorLight:"#ffffff",
    correctLevel: QRCode.CorrectLevel.H
  });
  return holder;
}

async function generateAndSend(){
  statusEl.textContent = "";
  clearQRCode();

  const name = (document.getElementById('name').value||"").trim();
  const value = (document.getElementById('value').value||"").trim();
  const type = (document.getElementById('type').value||"").trim();

  if(!name || !value || !type){
    statusEl.textContent = "‚ö†Ô∏è Preencha Nome, Valor e Tipo.";
    return;
  }

  const code = gerarCodigo();
  renderQRCode(code, 260);
  statusEl.textContent = "‚è≥ Gerando PDF...";

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'landscape', unit:'mm', format:[148,105]});
  const bgImg = await loadImage(BACKGROUND_IMG);
  const pageW = 148, pageH = 105;
  const ratio = Math.min(pageW / bgImg.width, pageH / bgImg.height);
  const imgW = bgImg.width * ratio;
  const imgH = bgImg.height * ratio;
  const x = (pageW - imgW) / 2;
  const y = (pageH - imgH) / 2;
  doc.addImage(bgImg, 'PNG', x, y, imgW, imgH);

  function drawText(txt, x, y){
    doc.setTextColor(0,0,0);
    doc.text(txt, x+0.4, y+0.4);
    doc.setTextColor(255,255,255);
    doc.text(txt, x, y);
  }

  doc.setFont("helvetica","bold");
  doc.setFontSize(13);
  drawText(`Nome: ${name}`, 12, 34);
  drawText(`Tipo: ${type}`, 12, 42);
  drawText(`Valor: R$ ${value}`, 12, 50);

  const holder = qrcodeDiv.querySelector('div');
  let qrImgData = null;
  if(holder){
    const canvas = holder.querySelector('canvas');
    if(canvas) qrImgData = canvas.toDataURL('image/png');
  }

  if(qrImgData){
    const qrWidthMm = 50;
    const qrHeightMm = 50;
    const xQr = 148 - qrWidthMm - 10;
    const yQr = 25;
    doc.addImage(qrImgData, 'PNG', xQr, yQr, qrWidthMm, qrHeightMm);
  }

  const safe = name.replace(/[^a-z0-9_\- ]/ig,'').slice(0,40);
  doc.save(`Ingresso_${safe}_${code}.pdf`);

  sendJsonp({ action: 'generate', name, value, type, codigo: code }, (err, resp) => {
    if(err){
      statusEl.textContent = "‚ùå Erro ao salvar (rede): " + err.message;
      return;
    }
    if(resp && resp.ok){
      statusEl.innerHTML = `‚úÖ Ingresso salvo com sucesso!`;
    } else {
      statusEl.textContent = "‚ùå Erro ao salvar: " + (resp?.error || resp?.message || 'Desconhecido');
    }
  });
}

function loadImage(url){
  return new Promise((resolve,reject)=>{
    const img = new Image();
    img.crossOrigin = "Anonymous";
    img.onload = ()=>resolve(img);
    img.onerror = ()=>reject(new Error("Erro ao carregar imagem"));
    img.src = url;
  });
}

// === SCANNER ===
function startScanner(){
  generator.style.display = "none";
  scannerArea.style.display = "flex";
  btnScan.style.display = "none";
  btnGen.style.display = "inline-block";
  scanStatus.textContent = "Aponte a c√¢mera para o QR Code do ingresso.";

  if(html5QrScanner) html5QrScanner.stop().catch(()=>{});
  html5QrScanner = new Html5Qrcode("reader");

  html5QrScanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 200 },
    qrCodeMessage => {
      validateTicket(qrCodeMessage);
    },
    errorMessage => {}
  ).catch(err => {
    scanStatus.textContent = "‚ùå Erro ao iniciar c√¢mera: " + err;
  });
}

function stopScanner(){
  generator.style.display = "block";
  scannerArea.style.display = "none";
  btnScan.style.display = "inline-block";
  btnGen.style.display = "none";
  if(html5QrScanner) html5QrScanner.stop().catch(()=>{});
}

function showMessage(text, isValid){
  overlay.style.display = "flex";
  overlay.textContent = text;
  overlay.style.backgroundColor = isValid ? "rgba(0,180,0,0.85)" : "rgba(220,0,0,0.85)";
  if(isValid) soundSuccess.play();
  else soundFail.play();
  setTimeout(()=>overlay.style.display="none",2000);
}

function validateTicket(code){
  sendJsonp({ action: "validate", codigo: code }, (err, resp)=>{
    if(err){
      showMessage("‚ùå Erro de rede!", false);
      return;
    }
    if(resp && resp.ok && resp.status === "OK"){
      showMessage(`‚úÖ Ingresso v√°lido!\n${resp.nome}\n${resp.tipo}\nR$ ${resp.valor}`, true);
    } else if(resp && resp.status === "USADO"){
      showMessage("‚ö†Ô∏è Ingresso j√° utilizado!", false);
    } else {
      showMessage("‚ùå Ingresso inv√°lido ou n√£o encontrado!", false);
    }
  });
}

btnGenerate.addEventListener('click', generateAndSend);
btnScan.addEventListener('click', startScanner);
btnGen.addEventListener('click', stopScanner);
</script>

</body>
</html>
