<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ğŸ« Gerador e Validador de Ingressos</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f0f2f5;
  margin: 0;
  padding: 20px;
}
.container {
  max-width: 430px;
  background: #fff;
  border-radius: 14px;
  margin: auto;
  padding: 18px;
  box-shadow: 0 6px 25px rgba(0,0,0,0.15);
}
h1 {
  text-align: center;
  margin: 0 0 12px;
}
input, select, button {
  width: 100%;
  padding: 10px;
  margin: 8px 0;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 15px;
}
button {
  background: #0078ff;
  color: #fff;
  border: none;
  font-weight: bold;
  cursor: pointer;
}
button:hover { background: #005be0; }
#qrcode { display: flex; justify-content: center; margin-top: 10px; }
#status { text-align: center; font-size: 14px; margin-top: 8px; }
video { width: 100%; border-radius: 8px; }
.hidden { display: none; }
</style>
</head>
<body>
<div class="container">
  <h1>ğŸ« Sistema de Ingressos</h1>

  <div id="menu">
    <button onclick="showGenerate()">Gerar Ingresso</button>
    <button onclick="showScanner()">Ler QR Code</button>
  </div>

  <div id="generateArea" class="hidden">
    <input id="name" placeholder="Nome completo" />
    <input id="value" placeholder="Valor (ex: 50)" />
    <select id="type">
      <option value="">â€” Tipo â€”</option>
      <option>VIP</option>
      <option>Pista</option>
      <option>Camarote</option>
    </select>
    <button id="btnGenerate">Gerar ingresso</button>
    <div id="qrcode"></div>
  </div>

  <div id="scannerArea" class="hidden">
    <video id="preview"></video>
    <p id="scanStatus">Aponte a cÃ¢mera para o QR Code...</p>
    <button onclick="stopScanner()">Parar</button>
  </div>

  <div id="status"></div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzZVETR1_gVv-ErwDtKPNn61k89PHUYCtujYeDD9NvuF2IiVEGhjqzT3CkwsG9UlVsMuA/exec";
const BACKGROUND_IMG = "https://i.imgur.com/91zRBfN.png";

const { jsPDF } = window.jspdf;
const statusEl = document.getElementById("status");
const qrcodeDiv = document.getElementById("qrcode");
let videoStream = null;
let scanning = false;

function showGenerate(){
  document.getElementById("generateArea").classList.remove("hidden");
  document.getElementById("scannerArea").classList.add("hidden");
  statusEl.textContent = "";
}
function showScanner(){
  document.getElementById("scannerArea").classList.remove("hidden");
  document.getElementById("generateArea").classList.add("hidden");
  startScanner();
}

function gerarCodigo(){
  const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  return Array.from({length:8},()=>chars[Math.floor(Math.random()*chars.length)]).join('');
}

function sendJsonp(paramsObj, cb){
  const callbackName = 'cb_' + Date.now();
  window[callbackName] = function(resp){
    cb(null, resp);
    delete window[callbackName];
    document.getElementById(callbackName + '_script')?.remove();
  };
  const qs = new URLSearchParams({...paramsObj, callback: callbackName}).toString();
  const script = document.createElement('script');
  script.id = callbackName + '_script';
  script.src = API_URL + '?' + qs;
  script.onerror = ()=>cb(new Error("Erro JSONP"));
  document.body.appendChild(script);
}

function clearQRCode(){ qrcodeDiv.innerHTML = ""; }
function renderQRCode(text){
  clearQRCode();
  const holder=document.createElement("div");
  qrcodeDiv.appendChild(holder);
  new QRCode(holder,{text,width:240,height:240});
  return holder;
}

document.getElementById("btnGenerate").addEventListener("click", async ()=>{
  const name=document.getElementById("name").value.trim();
  const value=document.getElementById("value").value.trim();
  const type=document.getElementById("type").value.trim();
  if(!name||!value||!type){statusEl.textContent="âš ï¸ Preencha todos os campos";return;}

  const code=gerarCodigo();
  renderQRCode(code);
  statusEl.textContent="â³ Gerando PDF...";

  const doc=new jsPDF({orientation:"landscape",unit:"mm",format:[148,105]});
  const bg=await loadImage(BACKGROUND_IMG);
  const w=148,h=105;
  const ratio=Math.min(w/bg.width,h/bg.height);
  const imgW=bg.width*ratio,imgH=bg.height*ratio;
  const x=(w-imgW)/2,y=(h-imgH)/2;
  doc.addImage(bg,"PNG",x,y,imgW,imgH);

  doc.setFont("helvetica","bold");
  doc.setFontSize(14);
  doc.setTextColor(255,255,255);
  doc.text(name,12,34);
  doc.setFontSize(12);
  doc.text(`${type} - R$ ${value}`,12,44);

  const qr=document.querySelector("#qrcode canvas");
  if(qr){
    const imgData=qr.toDataURL("image/png");
    doc.addImage(imgData,"PNG",108,30,35,35);
  }
  doc.save(`Ingresso_${name}_${code}.pdf`);

  sendJsonp({action:"generate",name,value,type,codigo:code},(err,resp)=>{
    if(err){statusEl.textContent="âŒ Erro: "+err.message;return;}
    if(resp?.ok){statusEl.textContent="âœ… Ingresso salvo!";}
    else{statusEl.textContent="âŒ Falha ao salvar.";}
  });
});

function loadImage(url){
  return new Promise((res,rej)=>{
    const img=new Image();
    img.crossOrigin="Anonymous";
    img.onload=()=>res(img);
    img.onerror=()=>rej();
    img.src=url;
  });
}

/* === SCANNER === */
async function startScanner(){
  statusEl.textContent="";
  const video=document.getElementById("preview");
  try{
    videoStream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:"environment",focusMode:"continuous"}
    });
    video.srcObject=videoStream;
    video.setAttribute("playsinline",true);
    await video.play();
    scanning=true;
    tick(video);
  }catch(err){
    statusEl.textContent="âŒ Erro ao acessar cÃ¢mera";
  }
}

function stopScanner(){
  scanning=false;
  if(videoStream){videoStream.getTracks().forEach(t=>t.stop());}
}

function tick(video){
  if(!scanning)return;
  const canvas=document.createElement("canvas");
  const ctx=canvas.getContext("2d");
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const imageData=canvas.toDataURL("image/png");
  detectQRCode(imageData);
  requestAnimationFrame(()=>tick(video));
}

function detectQRCode(imageData){
  // leitura via API rÃ¡pida
  if(!scanning)return;
  fetch("https://api.qrserver.com/v1/read-qr-code/",{
    method:"POST",
    body:new URLSearchParams({fileurl:imageData})
  })
  .then(r=>r.json())
  .then(data=>{
    const result=data?.[0]?.symbol?.[0]?.data;
    if(result){
      scanning=false;
      stopScanner();
      validateCode(result.trim());
    }
  }).catch(()=>{});
}

function validateCode(code){
  statusEl.textContent="â³ Validando...";
  sendJsonp({action:"validate",codigo:code},(err,resp)=>{
    if(err){statusEl.textContent="âŒ "+err.message;return;}
    if(resp?.ok && resp.status==="OK"){statusEl.textContent="âœ… Ingresso vÃ¡lido!";}
    else if(resp?.status==="USADO"){statusEl.textContent="âš ï¸ Ingresso jÃ¡ utilizado!";}
    else{statusEl.textContent="âŒ Ingresso invÃ¡lido!";}
  });
}
</script>
</body>
</html>
