<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>üé´ Ingressos</title>

<!-- Bibliotecas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
  body {
    font-family: "Poppins", Arial, sans-serif;
    background: linear-gradient(145deg, #001F3F, #007BFF);
    margin: 0;
    padding: 20px;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
  }

  .card {
    background: #fff;
    width: 100%;
    max-width: 420px;
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.15);
  }

  h1 {
    text-align: center;
    margin-bottom: 18px;
    color: #222;
    font-size: 20px;
    letter-spacing: 1px;
  }

  input, select, button {
    width: 100%;
    padding: 12px;
    margin: 8px 0;
    border-radius: 10px;
    border: 1px solid #ccc;
    font-size: 14px;
  }

  button {
    background: #007BFF;
    color: white;
    border: none;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.3s;
  }

  button:hover {
    background: #005FCC;
  }

  #qrcode {
    display: flex;
    justify-content: center;
    margin-top: 12px;
  }

  #status {
    text-align: center;
    margin-top: 10px;
    font-size: 14px;
  }

  /* Modal Scanner */
  #scannerModal {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.8);
    display: none;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    z-index: 9999;
  }

  #scannerModal.show {
    display: flex;
  }

  #reader {
    width: 300px;
    max-width: 90vw;
    background: #000;
    border-radius: 12px;
  }

  #scanResult {
    color: white;
    margin-top: 12px;
    font-size: 16px;
  }

  #closeScanner {
    margin-top: 15px;
    padding: 10px 18px;
    background: crimson;
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
  }
</style>
</head>
<body>

<div class="card">
  <h1>üéüÔ∏è GERADOR DE INGRESSOS</h1>

  <input id="name" placeholder="NOME COMPLETO" style="text-transform:uppercase" />
  <input id="value" placeholder="VALOR (EX: 50)" style="text-transform:uppercase" />
  <select id="type" style="text-transform:uppercase">
    <option value="">‚Äî SELECIONE O TIPO ‚Äî</option>
    <option value="PROMOCIONAL">PROMOCIONAL</option>
    <option value="NORMAL">NORMAL</option>
    <option value="VIP">VIP</option>
  </select>

  <button id="btnGenerate">GERAR INGRESSO</button>
  <button id="btnScanner" style="background:#28a745;margin-top:5px">üì∑ SCANEAR QR CODE</button>

  <div id="qrcode"></div>
  <div id="status"></div>
</div>

<!-- Modal do Scanner -->
<div id="scannerModal">
  <div id="reader"></div>
  <div id="scanResult"></div>
  <button id="closeScanner">Fechar</button>
</div>

<script>
/* =================== CONFIG =================== */
const API_URL = "https://script.google.com/macros/s/AKfycbxByOugkY5R0iKmuJj8Us9tTyoqjV5ZPNInExrKXRaKU_Gc5j8R1EqmSeV7U0rGHcp6/exec";
const BACKGROUND_IMG = "https://i.imgur.com/mAZQxpi.png";
/* ============================================== */

const btn = document.getElementById('btnGenerate');
const qrcodeDiv = document.getElementById('qrcode');
const statusEl = document.getElementById('status');

/* ========== Fun√ß√µes utilit√°rias ========== */
function gerarCodigo(){
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let out = "";
  for(let i=0;i<8;i++) out += chars.charAt(Math.floor(Math.random()*chars.length));
  return out;
}

function loadImage(url){
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = "Anonymous";
    img.onload = () => resolve(img);
    img.onerror = () => reject(new Error("Erro ao carregar imagem"));
    img.src = url;
  });
}

/* ========== JSONP robusto (Apps Script) ========== */
function sendJsonp(params, cb, timeoutMs = 8000){
  try {
    const cbName = 'cb_' + Date.now() + '_' + Math.floor(Math.random()*10000);
    window[cbName] = function(resp){
      try { cb(null, resp); } catch(e){ console.error(e); }
      delete window[cbName];
      document.getElementById(cbName + '_s')?.remove();
      clearTimeout(timeoutHandle);
    };
    const qs = new URLSearchParams({...params, callback: cbName}).toString();
    const script = document.createElement('script');
    script.id = cbName + '_s';
    script.src = API_URL + (API_URL.includes('?')? '&' : '?') + qs;
    script.onerror = () => {
      cb(new Error("Erro carregando JSONP"));
      delete window[cbName];
      script.remove();
      clearTimeout(timeoutHandle);
    };
    document.body.appendChild(script);
    const timeoutHandle = setTimeout(()=>{
      cb(new Error("Timeout JSONP"));
      delete window[cbName];
      script.remove();
    }, timeoutMs);
  } catch(err){ cb(err); }
}

/* ========== QR Code ========== */
function clearQRCode(){ qrcodeDiv.innerHTML = ""; }

function renderQRCode(text, size=240){
  clearQRCode();
  const holder = document.createElement('div');
  holder.style.background = "#fff";
  holder.style.padding = "6px";
  holder.style.borderRadius = "8px";
  qrcodeDiv.appendChild(holder);
  new QRCode(holder, { text, width: size, height: size, colorDark:"#000", colorLight:"#fff" });
  return holder;
}

/* ========== Gera√ß√£o do ingresso ========== */
async function generateAndSend(){
  statusEl.textContent = "";
  clearQRCode();

  const name = (document.getElementById('name').value || "").trim().toUpperCase();
  const value = (document.getElementById('value').value || "").trim().toUpperCase();
  const type = (document.getElementById('type').value || "").trim().toUpperCase();

  if(!name || !value || !type){
    statusEl.textContent = "‚ö†Ô∏è PREENCHA TODOS OS CAMPOS!";
    return;
  }

  const code = gerarCodigo();
  renderQRCode(code, 260);
  statusEl.textContent = "‚è≥ GERANDO PDF...";

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: "landscape", unit: "mm", format: [148,105] });

  const bgImg = await loadImage(BACKGROUND_IMG);
  const pageW = 148, pageH = 105;
  const ratio = Math.min(pageW / bgImg.width, pageH / bgImg.height);
  const imgW = bgImg.width * ratio;
  const imgH = bgImg.height * ratio;
  const x = (pageW - imgW) / 2;
  const y = (pageH - imgH) / 2;
  doc.addImage(bgImg, "PNG", x, y, imgW, imgH);

  doc.setFont("helvetica", "bold");
  doc.setTextColor(255,255,255);
  doc.setFontSize(26);
  doc.text(name, 15, 50);

  doc.setFontSize(14);
  doc.text(`VALOR: ${value} REAIS`, 15, 63);
  doc.text(`INGRESSO: ${type}`, 15, 72);

  // QR Code
  const holder = qrcodeDiv.querySelector("canvas");
  if(holder){
    const qrImg = holder.toDataURL("image/png");
    doc.addImage(qrImg, "PNG", 105, 30, 35, 35);
  }

  const safe = name.replace(/[^a-z0-9_\- ]/ig,'').slice(0,40);
  const pdfBase64 = doc.output("datauristring");

  sendJsonp({ action:"generate", name, value, type, codigo:code, pdfBase64 },
    (err, resp) => {
      if(err){
        statusEl.textContent = "‚ùå Erro ao salvar (rede): " + err.message;
        return;
      }
      if(resp && resp.ok){
        statusEl.innerHTML = `‚úÖ INGRESSO SALVO!<br>C√ìDIGO: <b>${code}</b>`;
      } else {
        statusEl.textContent = "‚ùå Erro ao salvar: " + (resp?.error || resp?.message || "Desconhecido");
      }
    }
  );

  doc.save(`INGRESSO_${safe}_${code}.pdf`);
}

/* ========== SCANNER ========== */
const modal = document.getElementById("scannerModal");
const scanResult = document.getElementById("scanResult");
const closeScannerBtn = document.getElementById("closeScanner");
let html5QrCodeInstance = null;

function openScanner(){
  modal.classList.add("show");
  scanResult.textContent = "Aponte a c√¢mera para o QR Code";
  html5QrCodeInstance = new Html5Qrcode("reader");

  Html5Qrcode.getCameras().then(cameras=>{
    if(!cameras.length){ scanResult.textContent="‚ùå Nenhuma c√¢mera detectada"; return; }
    let camId = cameras[0].id;
    for(const c of cameras){
      if((c.label||"").toLowerCase().includes("back")){ camId = c.id; break; }
    }
    html5QrCodeInstance.start(
      camId,
      { fps:10, qrbox:250 },
      decodedText=>{
        html5QrCodeInstance.stop().then(()=>validateCode(decodedText.trim()));
      },
      err=>{ console.debug("Scan erro", err); }
    ).catch(err=>{
      scanResult.textContent="‚ùå Erro ao iniciar c√¢mera: "+err.message;
    });
  }).catch(err=>{
    scanResult.textContent="‚ùå Erro ao acessar c√¢mera";
    console.error(err);
  });
}

function closeScanner(){
  modal.classList.remove("show");
  if(html5QrCodeInstance){
    html5QrCodeInstance.stop().catch(()=>{}).then(()=>html5QrCodeInstance.clear());
  }
}

function validateCode(code){
  scanResult.textContent = "‚è≥ Validando...";
  sendJsonp({ action:"validate", codigo:code }, (err,resp)=>{
    if(err){ scanResult.textContent="‚ùå Erro: "+err.message; return; }
    if(resp && resp.ok){
      if(resp.status==="OK"){
        scanResult.innerHTML=`‚úÖ Ingresso v√°lido!<br>${resp.nome}<br>${resp.valor}<br>${resp.tipo}`;
      }else{
        scanResult.innerHTML=`‚ö†Ô∏è ${resp.message||'Ingresso j√° utilizado'}`;
      }
    }else{
      scanResult.textContent="‚ùå C√≥digo n√£o encontrado.";
    }
  });
}

/* ========= EVENTOS ========= */
btn.addEventListener("click", generateAndSend);
document.getElementById("btnScanner").addEventListener("click", openScanner);
closeScannerBtn.addEventListener("click", closeScanner);
</script>
</body>
</html>
