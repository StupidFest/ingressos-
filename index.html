<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gerar Ingresso</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8f9fa;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 30px;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 320px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    input, select, button {
      padding: 8px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background: #007bff;
      color: white;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>
  <h2>üéüÔ∏è Gerar Ingresso Oficial</h2>

  <form id="ingressoForm">
    <input type="text" id="name" placeholder="Nome completo" required />
    <input type="number" id="value" placeholder="Valor" required />
    <select id="type" required>
      <option value="VIP">VIP</option>
      <option value="Pista">Pista</option>
      <option value="Camarote">Camarote</option>
    </select>
    <button type="submit">Gerar Ingresso</button>
  </form>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzZVETR1_gVv-ErwDtKPNn61k89PHUYCtujYeDD9NvuF2IiVEGhjqzT3CkwsG9UlVsMuA/exec";
    const backgroundUrl = "https://i.imgur.com/jjrAjpB.png";

    document.getElementById("ingressoForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const name = document.getElementById("name").value.trim();
      const value = document.getElementById("value").value.trim();
      const type = document.getElementById("type").value.trim();
      const codigo = gerarCodigo();

      // Gera QR Code
      const qrCanvas = document.createElement("canvas");
      new QRCode(qrCanvas, {
        text: codigo,
        width: 200,
        height: 200,
        correctLevel: QRCode.CorrectLevel.H
      });
      const qrData = qrCanvas.querySelector("img") ? qrCanvas.querySelector("img").src : qrCanvas.toDataURL("image/png");

      // Cria PDF
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: "portrait", unit: "px", format: "a4" });

      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();

      // Carrega imagem de fundo
      const img = new Image();
      img.crossOrigin = "Anonymous";
      img.src = backgroundUrl;
      img.onload = async () => {
        doc.addImage(img, "PNG", 0, 0, pageWidth, pageHeight);

        // Texto sobreposto
        doc.setFont("helvetica", "bold");
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(16);

        // Posi√ß√µes ajustadas para sobrepor o layout
        doc.text(`Nome: ${name}`, 60, 260);
        doc.text(`Tipo: ${type}`, 60, 280);
        doc.text(`Valor: R$ ${value}`, 60, 300);
        doc.text(`C√≥digo: ${codigo}`, 60, 320);

        // QR Code vis√≠vel e n√≠tido
        doc.addImage(qrData, "PNG", 340, 220, 130, 130);

        // Gera base64 do PDF
        const pdfBase64 = doc.output("datauristring");

        // Envia ao Google Apps Script
        const url = `${API_URL}?action=generate&name=${encodeURIComponent(name)}&value=${encodeURIComponent(value)}&type=${encodeURIComponent(type)}&codigo=${encodeURIComponent(codigo)}&pdfBase64=${encodeURIComponent(pdfBase64)}&callback=teste`;

        try {
          const res = await fetch(url);
          const text = await res.text();
          console.log("Resposta:", text);
          alert("‚úÖ Ingresso gerado e salvo com sucesso!");
        } catch (err) {
          console.error(err);
          alert("‚ùå Erro ao salvar ingresso!");
        }

        // Baixar localmente
        doc.save(`Ingresso_${name}_${codigo}.pdf`);
      };
    });

    function gerarCodigo() {
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      let code = "";
      for (let i = 0; i < 8; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
      return code;
    }
  </script>
</body>
</html>
