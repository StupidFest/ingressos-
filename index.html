<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>üé´ Ingressos</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
  font-family: "Poppins", Arial, sans-serif;
  background: linear-gradient(145deg, #001F3F, #007BFF);
  margin: 0; padding: 20px;
  display: flex; justify-content: center; align-items: flex-start;
  min-height: 100vh;
}
.card {
  background: #fff; width: 100%; max-width: 420px;
  padding: 20px; border-radius: 16px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.15);
}
h1 {
  text-align: center; margin-bottom: 18px;
  color: #222; font-size: 20px; letter-spacing: 1px;
}
input, select, button {
  width: 100%; padding: 12px; margin: 8px 0;
  border-radius: 10px; border: 1px solid #ccc; font-size: 14px;
  text-transform: uppercase;
}
button {
  background: #007BFF; color: white; border: none;
  font-weight: 700; cursor: pointer; transition: background 0.3s;
}
button:hover { background: #005FCC; }
#qrcode { display: flex; justify-content: center; margin-top: 12px; }
#status { text-align: center; margin-top: 10px; font-size: 14px; }

/* Scanner */
#scannerModal {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.85);
  display: none; align-items: center; justify-content: center; flex-direction: column;
  z-index: 9999;
}
#scannerModal.show { display: flex; }
#reader {
  width: 300px; max-width: 90vw; background: #000; border-radius: 12px;
}
#scanResult { color: white; margin-top: 12px; font-size: 16px; text-align:center; }
#closeScanner {
  margin-top: 15px; padding: 10px 18px;
  background: crimson; color: white; border: none;
  border-radius: 10px; cursor: pointer;
}
</style>
</head>
<body>

<div class="card">
  <h1>üéüÔ∏è GERADOR DE INGRESSOS</h1>

  <input id="name" placeholder="NOME COMPLETO" />
  <input id="value" placeholder="VALOR (EX: 50)" />
  <select id="type">
    <option value="">‚Äî SELECIONE O TIPO ‚Äî</option>
    <option value="PROMOCIONAL">PROMOCIONAL</option>
    <option value="NORMAL">NORMAL</option>
    <option value="VIP">VIP</option>
  </select>

  <button id="btnGenerate">GERAR INGRESSO</button>
  <button id="btnScanner" style="background:#28a745;margin-top:5px">üì∑ SCANEAR QR CODE</button>

  <div id="qrcode"></div>
  <div id="status"></div>
</div>

<div id="scannerModal">
  <div id="reader"></div>
  <div id="scanResult"></div>
  <button id="closeScanner">Fechar</button>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxByOugkY5R0iKmuJj8Us9tTyoqjV5ZPNInExrKXRaKU_Gc5j8R1EqmSeV7U0rGHcp6/exec";
const BACKGROUND_IMG = "https://i.imgur.com/91zRBfN.png";

const statusEl = document.getElementById('status');
const qrcodeDiv = document.getElementById('qrcode');

function gerarCodigo(){
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  return Array.from({length:8},()=>chars[Math.floor(Math.random()*chars.length)]).join('');
}

function sendJsonpOrFetch(params, cb){
  const cbName = "cb_" + Date.now();
  window[cbName] = (resp) => { cb(null, resp); cleanup(); };
  function cleanup(){
    delete window[cbName];
    document.getElementById(cbName+"_s")?.remove();
    clearTimeout(tmo);
  }
  const script = document.createElement("script");
  script.id = cbName+"_s";
  script.src = API_URL + "?" + new URLSearchParams({...params, callback: cbName});
  script.onerror = ()=>{ cleanup(); fetchFallback(); };
  document.body.appendChild(script);
  const tmo = setTimeout(()=>{ cleanup(); fetchFallback(); }, 6000);

  function fetchFallback(){
    fetch(API_URL+"?"+new URLSearchParams(params),{mode:"no-cors"})
    .then(()=>cb(null,{ok:true,fallback:true}))
    .catch(e=>cb(e));
  }
}

function renderQRCode(text){
  qrcodeDiv.innerHTML="";
  const holder=document.createElement("div");
  holder.style.background="#fff";holder.style.padding="6px";holder.style.borderRadius="8px";
  qrcodeDiv.appendChild(holder);
  new QRCode(holder,{text,width:240,height:240});
  return holder;
}

async function generateAndSend(){
  const name=document.getElementById('name').value.trim().toUpperCase();
  const value=document.getElementById('value').value.trim().toUpperCase();
  const type=document.getElementById('type').value.trim().toUpperCase();
  if(!name||!value||!type){ statusEl.textContent="‚ö†Ô∏è PREENCHA TODOS OS CAMPOS!"; return; }

  const code=gerarCodigo();
  renderQRCode(code);
  statusEl.textContent="‚è≥ Gerando PDF...";

  const { jsPDF } = window.jspdf;
  const bg = await new Promise((res,rej)=>{const i=new Image();i.crossOrigin="anonymous";i.onload=()=>res(i);i.onerror=rej;i.src=BACKGROUND_IMG;});

  // Define PDF do tamanho EXATO da imagem
  const doc = new jsPDF({ orientation:"landscape", unit:"px", format:[bg.width, bg.height] });
  doc.addImage(bg, "PNG", 0, 0, bg.width, bg.height);

  doc.setFont("helvetica","bold");
  doc.setTextColor(255,255,255);
  doc.setFontSize(46);
  doc.text(name, 60, bg.height - 230);
  doc.setFontSize(28);
  doc.text(`VALOR: ${value} REAIS`, 60, bg.height - 180);
  doc.text(`INGRESSO: ${type}`, 60, bg.height - 140);

  const qrCanvas=qrcodeDiv.querySelector("canvas");
  if(qrCanvas){
    const qrSize = 180;
    doc.addImage(qrCanvas.toDataURL("image/png"),"PNG", bg.width - qrSize - 60, bg.height - qrSize - 80, qrSize, qrSize);
  }

  doc.save(`INGRESSO_${name}_${code}.pdf`);

  sendJsonpOrFetch({action:"generate",name,value,type,codigo:code},(err,resp)=>{
    if(err){ statusEl.textContent="‚ùå Erro ao salvar: "+err.message; return; }
    if(resp?.ok){ statusEl.textContent="‚úÖ Ingresso salvo com sucesso!"; }
    else{ statusEl.textContent="‚ö†Ô∏è Salvo localmente, sem resposta da planilha."; }
  });
}

/* Scanner */
const modal=document.getElementById("scannerModal");
const scanResult=document.getElementById("scanResult");
const closeScannerBtn=document.getElementById("closeScanner");
let html5QrCodeInstance=null;

function openScanner(){
  modal.classList.add("show");
  scanResult.textContent="Aponte a c√¢mera para o QR Code";
  html5QrCodeInstance=new Html5Qrcode("reader");
  Html5Qrcode.getCameras().then(cameras=>{
    if(!cameras.length){scanResult.textContent="‚ùå Nenhuma c√¢mera encontrada";return;}
    const backCam=cameras.find(c=>c.label.toLowerCase().includes("back"))||cameras[0];
    html5QrCodeInstance.start(backCam.id,{fps:10,qrbox:250},
      decoded=>{
        html5QrCodeInstance.stop().then(()=>validateCode(decoded.trim()));
      });
  }).catch(e=>{scanResult.textContent="‚ùå Erro c√¢mera";console.error(e);});
}
function closeScanner(){
  modal.classList.remove("show");
  if(html5QrCodeInstance){html5QrCodeInstance.stop().catch(()=>{});}
}
function validateCode(code){
  scanResult.textContent="‚è≥ Validando...";
  sendJsonpOrFetch({action:"validate",codigo:code},(err,resp)=>{
    if(err){scanResult.textContent="‚ùå "+err.message;return;}
    if(resp?.ok){
      scanResult.innerHTML=`‚úÖ ${resp.nome||"Ingresso"} v√°lido<br>${resp.tipo||""} - ${resp.valor||""}`;
    }else{
      scanResult.textContent="‚ö†Ô∏è C√≥digo n√£o encontrado ou j√° usado";
    }
  });
}
document.getElementById("btnGenerate").onclick=generateAndSend;
document.getElementById("btnScanner").onclick=openScanner;
closeScannerBtn.onclick=closeScanner;
</script>
</body>
</html>
