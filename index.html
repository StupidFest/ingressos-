<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Gerador de Ingressos + Scanner</title>

<!-- Libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
body{font-family:Arial,sans-serif;background:#f0f2f5;display:flex;align-items:center;justify-content:center;flex-direction:column;height:100vh;margin:0;padding:20px}
.card{width:100%;max-width:420px;background:#fff;border-radius:12px;padding:18px;box-shadow:0 8px 30px rgba(0,0,0,0.12)}
h1{margin:0 0 12px;font-size:20px;text-align:center}
input,select,button{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #ddd;font-size:14px}
button{background:#0069ff;color:#fff;border:none;cursor:pointer;font-weight:700}
#qrcode{display:flex;justify-content:center;margin-top:10px}
#status{margin-top:8px;font-size:14px;text-align:center}
#reader{width:100%;max-width:420px;margin-top:20px;display:none}
</style>
</head>
<body>

<div class="card">
  <h1>ğŸ« Gerador de Ingressos</h1>
  <input id="name" placeholder="Nome completo" />
  <input id="value" placeholder="Valor (ex: 50)" />
  <select id="type">
    <option value="">â€” Selecione tipo â€”</option>
    <option>VIP</option>
    <option>Pista</option>
    <option>Camarote</option>
  </select>
  <button id="btnGenerate">Gerar ingresso</button>
  <button id="btnScan">ğŸ“· Ler Ingresso (Scanner)</button>

  <div id="qrcode"></div>
  <div id="status"></div>
</div>

<div id="reader"></div>

<script>
/* ========== CONFIG ========== */
const API_URL = "https://script.google.com/macros/s/AKfycbzZVETR1_gVv-ErwDtKPNn61k89PHUYCtujYeDD9NvuF2IiVEGhjqzT3CkwsG9UlVsMuA/exec";
const BACKGROUND_IMG = "https://i.imgur.com/91zRBfN.png";
/* =========================== */

const btnGen = document.getElementById('btnGenerate');
const btnScan = document.getElementById('btnScan');
const qrcodeDiv = document.getElementById('qrcode');
const statusEl = document.getElementById('status');
const readerDiv = document.getElementById('reader');

function gerarCodigo(){
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  return Array.from({length:8},()=>chars[Math.floor(Math.random()*chars.length)]).join('');
}

function sendJsonp(paramsObj, cb){
  const callbackName = 'cb_' + Date.now() + '_' + Math.floor(Math.random()*10000);
  window[callbackName] = function(resp){
    cb(null, resp);
    delete window[callbackName];
    document.getElementById(callbackName + '_script')?.remove();
  };
  const qs = new URLSearchParams({...paramsObj, callback: callbackName}).toString();
  const script = document.createElement('script');
  script.id = callbackName + '_script';
  script.src = API_URL + (API_URL.includes('?')? '&' : '?') + qs;
  script.onerror = () => cb(new Error('Erro JSONP'));
  document.body.appendChild(script);
}

function clearQRCode(){ qrcodeDiv.innerHTML = ""; }

function renderQRCode(text, size=240){
  clearQRCode();
  const holder = document.createElement('div');
  holder.style.background = "#fff";
  holder.style.padding = "8px";
  holder.style.borderRadius = "8px";
  qrcodeDiv.appendChild(holder);
  new QRCode(holder, { text, width: size, height: size, colorDark:"#000", colorLight:"#fff", correctLevel: QRCode.CorrectLevel.H });
  return holder;
}

function loadImage(url){
  return new Promise((resolve,reject)=>{
    const img = new Image();
    img.crossOrigin = "Anonymous";
    img.onload = ()=>resolve(img);
    img.onerror = ()=>reject(new Error("Erro ao carregar imagem"));
    img.src = url;
  });
}

async function generateAndSend(){
  statusEl.textContent = "";
  clearQRCode();
  const name = (document.getElementById('name').value||"").trim().toUpperCase();
  const value = (document.getElementById('value').value||"").trim().toUpperCase();
  const type = (document.getElementById('type').value||"").trim().toUpperCase();
  if(!name || !value || !type){ statusEl.textContent = "âš ï¸ Preencha Nome, Valor e Tipo."; return; }

  const code = gerarCodigo();
  renderQRCode(code, 260);
  statusEl.textContent = "â³ Gerando PDF...";

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'landscape', unit:'mm', format:[148,105]});
  const bgImg = await loadImage(BACKGROUND_IMG);
  doc.addImage(bgImg, 'PNG', 0, 0, 148, 105);

  doc.setFont("helvetica","bold");
  doc.setFontSize(18);
  doc.setTextColor(255,255,255);
  doc.text(name, 12, 40);
  doc.setFontSize(14);
  doc.text(`TIPO: ${type}`, 12, 50);
  doc.text(`VALOR: R$ ${value}`, 12, 58);
  doc.text(`CÃ“DIGO: ${code}`, 12, 66);

  const holder = qrcodeDiv.querySelector('div canvas');
  if(holder){
    const qrImgData = holder.toDataURL('image/png');
    doc.addImage(qrImgData, 'PNG', 148-50-10, 25, 50, 50);
  }

  doc.save(`Ingresso_${name}_${code}.pdf`);

  sendJsonp({ action: 'generate', name, value, type, codigo: code }, (err, resp)=>{
    if(err){ statusEl.textContent = "âŒ Erro ao salvar (rede): " + err.message; return; }
    if(resp?.ok){ statusEl.innerHTML = `âœ… Ingresso salvo! CÃ³digo: <b>${resp.codigo}</b>`; }
    else { statusEl.textContent = "âŒ Erro ao salvar: " + (resp?.error || resp?.message || 'Desconhecido'); }
  });
}

/* ====== SCANNER ====== */
btnScan.addEventListener('click', ()=>{
  readerDiv.style.display='block';
  qrcodeDiv.style.display='none';
  statusEl.textContent = "ğŸ“· Aponte para o QR Code do ingresso...";
  const html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: { width: 250, height: 250 } },
    (decodedText)=>{
      html5QrCode.stop();
      readerDiv.style.display='none';
      statusEl.innerHTML = "â³ Validando ingresso...";
      sendJsonp({ action:"usar", codigo: decodedText }, (err, resp)=>{
        if(err){ statusEl.textContent="âŒ Erro ao validar: "+err.message; return; }
        if(resp?.ok){ statusEl.innerHTML = "âœ… Ingresso validado e marcado como usado!"; }
        else { statusEl.textContent = "âš ï¸ Ingresso invÃ¡lido ou jÃ¡ utilizado."; }
      });
    },
    (errorMsg)=>{}
  ).catch(err=>{
    statusEl.textContent="âŒ Erro ao acessar cÃ¢mera: "+err;
  });
});

btnGen.addEventListener('click', generateAndSend);
</script>
</body>
</html>
