<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Gerador de Ingressos - Corrigido</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  body{font-family:Arial,sans-serif;background:#f0f2f5;display:flex;align-items:center;justify-content:center;height:100vh;margin:0;padding:20px}
  .card{width:100%;max-width:420px;background:#fff;border-radius:12px;padding:18px;box-shadow:0 8px 30px rgba(0,0,0,0.12)}
  h1{margin:0 0 12px;font-size:20px;text-align:center}
  input,select,button{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #ddd;font-size:14px}
  button{background:#0069ff;color:#fff;border:none;cursor:pointer;font-weight:700}
  #qrcode{display:flex;justify-content:center;margin-top:10px}
  #status{margin-top:8px;font-size:14px;text-align:center}
</style>
</head>
<body>

<div class="card">
  <h1>üé´ Gerador de Ingressos</h1>
  <input id="name" placeholder="Nome completo" />
  <input id="value" placeholder="Valor (ex: 50)" />
  <select id="type">
    <option value="">‚Äî Selecione tipo ‚Äî</option>
    <option>VIP</option>
    <option>Pista</option>
    <option>Camarote</option>
  </select>
  <button id="btnGenerate">Gerar ingresso</button>

  <div id="qrcode"></div>
  <div id="status"></div>
</div>

<script>
/* ========== CONFIG ========== */
const API_URL = "https://script.google.com/macros/s/AKfycbzZVETR1_gVv-ErwDtKPNn61k89PHUYCtujYeDD9NvuF2IiVEGhjqzT3CkwsG9UlVsMuA/exec";
const BACKGROUND_IMG = "https://i.imgur.com/jjrAjpB.png";
/* =========================== */

const btn = document.getElementById('btnGenerate');
const qrcodeDiv = document.getElementById('qrcode');
const statusEl = document.getElementById('status');

function gerarCodigo(){
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let out="";
  for(let i=0;i<8;i++) out+=chars.charAt(Math.floor(Math.random()*chars.length));
  return out;
}

function sendJsonp(paramsObj, cb){
  const callbackName = 'cb_' + Date.now() + '_' + Math.floor(Math.random()*10000);
  window[callbackName] = function(resp){
    cb(null, resp);
    delete window[callbackName];
    document.getElementById(callbackName + '_script')?.remove();
  };
  const qs = new URLSearchParams({...paramsObj, callback: callbackName}).toString();
  const script = document.createElement('script');
  script.id = callbackName + '_script';
  script.src = API_URL + (API_URL.includes('?')? '&' : '?') + qs;
  script.onerror = () => cb(new Error('Erro JSONP'));
  document.body.appendChild(script);
}

function clearQRCode(){
  qrcodeDiv.innerHTML = "";
}

function renderQRCode(text, size=240){
  clearQRCode();
  const holder = document.createElement('div');
  holder.style.background = "#fff";
  holder.style.padding = "8px";
  holder.style.borderRadius = "8px";
  qrcodeDiv.appendChild(holder);
  new QRCode(holder, { text, width: size, height: size, colorDark:"#000000", colorLight:"#ffffff", correctLevel: QRCode.CorrectLevel.H });
  return holder;
}

async function generateAndSend(){
  statusEl.textContent = "";
  clearQRCode();

  const name = (document.getElementById('name').value||"").trim();
  const value = (document.getElementById('value').value||"").trim();
  const type = (document.getElementById('type').value||"").trim();

  if(!name || !value || !type){ statusEl.textContent = "‚ö†Ô∏è Preencha Nome, Valor e Tipo."; return; }

  const code = gerarCodigo();

  // ‚úÖ QR cont√©m EXATAMENTE o c√≥digo
  renderQRCode(code, 260);
  statusEl.textContent = "‚è≥ Gerando PDF...";

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'landscape', unit:'mm', format:[148,105]});

  const bgImg = await loadImage(BACKGROUND_IMG);

  // Calcular propor√ß√£o correta
  const pageW = 148, pageH = 105;
  const ratio = Math.min(pageW / bgImg.width, pageH / bgImg.height);
  const imgW = bgImg.width * ratio;
  const imgH = bgImg.height * ratio;
  const x = (pageW - imgW) / 2;
  const y = (pageH - imgH) / 2;

  doc.addImage(bgImg, 'PNG', x, y, imgW, imgH);

  // Texto leg√≠vel: branco com sombra
  function drawText(txt, x, y){
    doc.setTextColor(0,0,0);
    doc.text(txt, x+0.4, y+0.4);
    doc.setTextColor(255,255,255);
    doc.text(txt, x, y);
  }

  doc.setFont("helvetica","bold");
  doc.setFontSize(13);
  drawText(`Nome: ${name}`, 12, 34);
  drawText(`Tipo: ${type}`, 12, 42);
  drawText(`Valor: R$ ${value}`, 12, 50);
  drawText(`C√≥digo: ${code}`, 12, 58);

  const holder = qrcodeDiv.querySelector('div');
  let qrImgData = null;
  if(holder){
    const canvas = holder.querySelector('canvas');
    if(canvas){ qrImgData = canvas.toDataURL('image/png'); }
  }

  if(qrImgData){
    const qrWidthMm = 40;
    const qrHeightMm = 40;
    const xQr = 148 - qrWidthMm - 10;
    const yQr = 25;
    doc.addImage(qrImgData, 'PNG', xQr, yQr, qrWidthMm, qrHeightMm);
  }

  const safe = name.replace(/[^a-z0-9_\- ]/ig,'').slice(0,40);
  doc.save(`Ingresso_${safe}_${code}.pdf`);

  sendJsonp({ action: 'generate', name, value, type, codigo: code }, (err, resp) => {
    if(err){
      statusEl.textContent = "‚ùå Erro ao salvar (rede): " + err.message;
      return;
    }
    if(resp && resp.ok){
      statusEl.innerHTML = `‚úÖ Ingresso salvo! C√≥digo: <b>${resp.codigo}</b>`;
    } else {
      statusEl.textContent = "‚ùå Erro ao salvar: " + (resp?.error || resp?.message || 'Desconhecido');
    }
  });
}

function loadImage(url){
  return new Promise((resolve,reject)=>{
    const img = new Image();
    img.crossOrigin = "Anonymous";
    img.onload = ()=>resolve(img);
    img.onerror = ()=>reject(new Error("Erro ao carregar imagem"));
    img.src = url;
  });
}

btn.addEventListener('click', generateAndSend);
</script>
</body>
</html>
